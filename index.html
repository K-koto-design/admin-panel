<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель Поддержки</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        #user-list { width: 300px; border-right: 1px solid #ccc; background: #fff; overflow-y: auto; }
        #chat-area { flex: 1; display: flex; flex-direction: column; }
        .user-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #f9f9f9; }
        .user-item.active { background: #e7f3ff; border-left: 4px solid #007aff; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg { max-width: 70%; padding: 10px; margin-bottom: 10px; border-radius: 10px; }
        .msg.user { align-self: flex-start; background: #fff; border: 1px solid #ddd; }
        .msg.admin { align-self: flex-end; background: #007aff; color: white; }
        .input-box { padding: 20px; background: #fff; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; background: #007aff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="user-list">
    <h3 style="padding: 15px;">Диалоги</h3>
    <div id="users"></div>
</div>

<div id="chat-area">
    <div id="messages">Выберите чат слева</div>
    <div class="input-box">
        <input type="text" id="adminMsg" placeholder="Введите ответ...">
        <button onclick="sendReply()">Отправить</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
        authDomain: "webapp-b7149.firebaseapp.com",
        databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "webapp-b7149",
        storageBucket: "webapp-b7149.firebasestorage.app",
        messagingSenderId: "1034835242406",
        appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('clients');

    let clientsData = {};
    let selectedUserId = null;

    // Слушаем обновления базы clients
    dbRef.on('value', (snapshot) => {
        clientsData = snapshot.val() || {};
        renderUserList();
        if (selectedUserId) renderMessages();
    });

    function renderUserList() {
        const container = document.getElementById('users');
        container.innerHTML = "";
        
        // Работаем с ключами объекта (ID клиентов)
        Object.keys(clientsData).forEach(key => {
            const user = clientsData[key];
            
            // Получаем последнее сообщение для превью
            let lastMsgText = 'Нет сообщений';
            if (user.chat) {
                const chatArray = Object.values(user.chat);
                if (chatArray.length > 0) {
                    lastMsgText = chatArray[chatArray.length - 1].text;
                }
            }
            
            const div = document.createElement('div');
            div.className = `user-item ${selectedUserId === key ? 'active' : ''}`;
            div.innerHTML = `
                <strong>${user.name || 'Без имени'} ${user.orgType === 'ИП' ? '<span style="font-size:10px; background:#000; color:#fff; padding:1px 4px; border-radius:3px;">ИП</span>' : ''}</strong><br>
                <small style="color: #666;">${lastMsgText.substring(0, 30)}${lastMsgText.length > 30 ? '...' : ''}</small>
            `;
            div.onclick = () => { 
                selectedUserId = key; 
                renderMessages(); 
                renderUserList(); 
            };
            container.appendChild(div);
        });
    }

    function renderMessages() {
        const container = document.getElementById('messages');
        const user = clientsData[selectedUserId];
        
        if (!user) {
            container.innerHTML = "Выберите чат слева";
            return;
        }

        container.innerHTML = `<h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Чат с ${user.name}</h4>`;
        
        if (user.chat) {
            // Превращаем объект сообщений в массив и сортируем по времени (если есть поле time)
            const chatArray = Object.values(user.chat);
            chatArray.forEach(m => {
                const d = document.createElement('div');
                // Если роль 'user' или 'client' — прижимаем влево, если 'admin' — вправо
                d.className = `msg ${m.role === 'admin' ? 'admin' : 'user'}`;
                d.innerText = m.text;
                container.appendChild(d);
            });
        }
        container.scrollTop = container.scrollHeight;
    }

    function sendReply() {
        const input = document.getElementById('adminMsg');
        const text = input.value.trim();
        
        if (!text || !selectedUserId) return;

        const newMessage = {
            role: 'admin',
            text: text,
            time: firebase.database.ServerValue.TIMESTAMP
        };

        // Сохраняем сообщение именно в ветку выбранного клиента
        firebase.database().ref(`clients/${selectedUserId}/chat`).push(newMessage)
            .then(() => {
                input.value = "";
            })
            .catch(err => {
                console.error("Ошибка:", err);
                alert("Не удалось отправить сообщение");
            });
    }

    // Слушатель клавиши Enter
    document.getElementById('adminMsg').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendReply();
    });
</script>
</body>
</html>
